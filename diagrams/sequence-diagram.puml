@startuml Diagrama de Secuencia - Operación con Memento

title Secuencia de Operación con Patrón Memento\n(Ejemplo: Evaluar "5+5-2" y luego Undo)

actor "Cliente" as Client
participant "Express\nApp" as App
participant "Calculator\nRoutes" as Routes
participant "Calculator\nController" as Controller
participant "Calculator\n(Originator)" as Calculator
participant "History\n(Caretaker)" as History
participant "Memento" as Memento

== Operación: Evaluar Expresión ==

Client -> App: POST /api/calculator/evaluate\n{"expression":"5+5-2"}
activate App

App -> Routes: route("/evaluate")
activate Routes

Routes -> Controller: evaluateExpression(req, res, next)
activate Controller

Controller -> Controller: Validar datos (expression)

Controller -> Calculator: evaluate("5+5-2")
activate Calculator

Calculator -> Calculator: tokenize("5+5-2")
Calculator -> Calculator: toRPN(tokens)
Calculator -> Calculator: evalRPN(rpn)
Calculator -> Calculator: currentValue = 8
Calculator -> Calculator: lastOperation = "5+5-2"

Calculator --> Controller: return 8
deactivate Calculator

Controller -> Calculator: save()
activate Calculator

Calculator -> Memento: new CalculatorMemento(8, "5+5-2")
activate Memento
Memento --> Calculator: memento instance
deactivate Memento

Calculator --> Controller: return memento
deactivate Calculator

Controller -> History: push(memento)
activate History
History -> History: mementos.push(memento)
History -> History: currentIndex++
History --> Controller: void
deactivate History

Controller --> Routes: res.json({success: true, result: 10, ...})
deactivate Controller

Routes --> App: response
deactivate Routes

App --> Client: 200 OK\n{"success":true, "data":{"result":8, "operation":"5+5-2"}}
deactivate App

== Operación: Deshacer (Undo) ==

Client -> App: POST /api/calculator/undo
activate App

App -> Routes: route("/undo")
activate Routes

Routes -> Controller: undo(req, res, next)
activate Controller

Controller -> History: canUndo()
activate History
History --> Controller: true
deactivate History

Controller -> History: undo()
activate History

History -> History: currentIndex--
History -> History: memento = mementos[currentIndex]

History --> Controller: return memento
deactivate History

Controller -> Calculator: restore(memento)
activate Calculator

Calculator -> Memento: getState()
activate Memento
Memento --> Calculator: 0
deactivate Memento

Calculator -> Calculator: currentValue = 0
Calculator -> Calculator: lastOperation = "initial"

Calculator --> Controller: void
deactivate Calculator

Controller --> Routes: res.json({success: true, ...})
deactivate Controller

Routes --> App: response
deactivate Routes

App --> Client: 200 OK\n{"success":true, "data":{"currentValue":0, ...}}
deactivate App

note over Client, Memento
  <b>Patrón Memento en acción:</b>
  1. Calculator evalúa la expresión internamente (tokenize → RPN → eval)
  2. Calculator crea un Memento después de cada operación
  3. History almacena el Memento en su colección
  4. En undo, History recupera el Memento anterior
  5. Calculator restaura su estado desde el Memento
end note

@enduml
